const _ = require('lodash');
const fs = require('fs');
const deref = require('json-schema-deref-sync');
const r = require('root/lib/db');

var indexes = {}

const schema = fs.readdirSync('./schemas').reduce((s, file) => {
  const name = file.split('.json')[0];
  s[name] = require('./schemas/'+file);
  return s;
}, {});

const getIndexes = tableName => {
  return r.table(tableName).indexList().run()
    .then(indexes => [tableName, indexes])
}

exports.setIndexes = () => {
  return r.tableList().run()
  .then(tables => _.reject(tables, t => t === '_migrations'))
  .then(tables => Promise.all(tables.map(getIndexes)))
  .then(_.zipObject)
  .then(result => indexes = result);
}

exports.getSchema = () => {
  return deref(schema);
}
