const fs = require('fs');
const mustache = require('mustache');
const path = require('path');

const now = new Date().toISOString();
const migrationName = `${now}_${process.argv[2]}`;
const root = path.resolve(__dirname, '..');
const opts = { migrationName };

const migrationTemplate = fs.readFileSync(`${root}/bin/migration_template.mustache`).toString();
const migrationTestTemplate = fs.readFileSync(`${root}/bin/migration_template_test.mustache`).toString();

const migrationFile = mustache.render(migrationTemplate, opts);
const migrationTest = mustache.render(migrationTestTemplate, opts);

[`${root}/migrations/`, `${root}/test/migrations/`].forEach(p => {
  try {
    fs.mkdirSync(p);
  } catch (e) {
    if (e.code !== 'EEXIST') throw e;
  }
});

fs.writeFileSync(`${root}/migrations/${migrationName}.js`, migrationFile);
fs.writeFileSync(`${root}/test/migrations/${migrationName}.js`, migrationTest);
